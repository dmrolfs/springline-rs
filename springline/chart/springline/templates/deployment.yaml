apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "common.fullname" . }}
  labels:
{{ include "common.labels" . | indent 4 }}
    component: {{ .Values.component }}
  annotations:
{{ include "common.annotations" . | indent 4 }}
    prometheus.io/path: "/metrics"
    prometheus.io/port: '9898'
    prometheus.io/scrapehifreq: "true"
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
{{ include "common.labels" . | indent 6 }}
  template:
    metadata:
      labels:
{{ include "common.labels" . | indent 8 }}
    spec:
#      affinity:

#        preferredDuringSchedulingIgnoredDuringExecution:
#          - weight: 100
#            podAffinityTerm:
#              labelSelector:
#                matchExpressions:
#                  - key: app
#                    operator: In
#                    values:
#                      - {{ include "common.name" . }}
#              topologyKey: kubernetes.io/hostname
    {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
    {{- end }}
      serviceAccountName: {{ template "springline.serviceAccountName" . }}
      nodeSelector:
        workload: {{ .Values.deployment.nodeGroup | quote }}
      tolerations:
      - key: workload
        operator: Equal
        value: {{ .Values.deployment.nodeGroup | quote }}
        effect: NoSchedule
      containers:
      - name: flink-autoscaler
        image: {{ .Values.image.repository }}/{{ .Values.image.path }}:{{ required ".Values.image.tag is not set" .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        - name: APP_ENVIRONMENT
          value: "cluster"
        - name: RUST_LOG
          value: "info,springline::flink=debug,springline::kubernetes=debug,springline::phases::act=trace,proctor::phases::sense::clearinghouse=info,springline::phases::plan::performance_repository=debug"
        - name: RUST_BACKTRACE
          value: "1"
        - name: POLAR_LOG
          value: "1"
        ports:
        - containerPort: 80
{{- if .Values.deployment.enableProbes }}
        livenessProbe:
          httpGet:
            path: "/health/live"
            scheme: "HTTP"
            port: {{ .Values.service.targetPort }}
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: "/health/ready"
            scheme: "HTTP"
            port: {{ .Values.service.targetPort }}
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
{{- end }}
        resources:
          requests:
            cpu: 100m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 50Mi
        volumeMounts:
        - name: autoscaler-config
          mountPath: "/opt/springline/cluster.yaml"
          subPath: "cluster.yaml"
        - name: {{ include "common.name" . }}-aaa-credentials
          mountPath: "/opt/springline/credentials"
        - name: {{ include "common.name" . }}-accounting
          mountPath: "/opt/springline/accounting"
      volumes:
      - name: autoscaler-config
        configMap:
          name: {{ include "common.name" . }}-config
          items:
            - key: autoscaler.yaml
              path: cluster.yaml
      - name: {{ include "common.name" . }}-aaa-credentials
        secret:
          secretName: {{ required "Values.deployment.aaaClientSecretsName is not set" .Values.deployment.aaaClientSecretsName }}
      - name: {{ include "common.name" . }}-accounting
        secret:
          secretName: {{ .Values.deployment.accountSecretsName }}